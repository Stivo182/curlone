<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">

     <!-- favicon -->
    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="images/favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <!-- /favicon -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Mono&display=swap');

        body {
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
            font-family: "PT Mono", monospace;
            font-weight: 400;
            font-style: normal;
            color: black;
        }

        div {
            display: flex;
            flex-flow: column;
            width: calc(100% - 50px);
            align-items: center;
        }

        a {
            color: black;
        }

        p {
            font-size: 12px;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-flow: column;
            justify-content: center;
            margin-bottom: 10px;
            align-items: center;
        }

        .logo {
            width: 200px;
        }

        textarea {
            width: 100%;
            resize: vertical;
            border-radius: 0;
            border: 2px solid black;
            overflow-y: scroll;
            overflow-x: scroll;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        textarea::placeholder {
            color: #777;
        }

        input[type=button] {
            background-color: black;
            color: white;
            padding: 10px 10px;
            border: none;
        }

        .container div {
            width: 1000px;
            display: flex;
            align-items: flex-start;
        }

        div.logo {
            justify-content: center;
            align-items: center;
        }

        div.output {
            width: 100%;
            height: 200px;
            border: 2px solid black;
            padding: 3px;
            resize: vertical;
            overflow: auto;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        pre.shiki {
            margin: 0;
        }

        .selectable {
            -webkit-touch-callout: all; /* iOS Safari */
            -webkit-user-select: all; /* Safari */
            -khtml-user-select: all; /* Konqueror HTML */
            -moz-user-select: all; /* Firefox */
            -ms-user-select: all; /* Internet Explorer/Edge */
            user-select: all; /* Chrome and Opera */
        }

        #warnings, #errors {
            font-size: 12px;
            padding: 8px 12px;
            margin: 10px 0px;
            border-radius: 3px;
            border: 1px solid;
            line-height: 1.5;
            width: 100%;
            box-sizing: border-box;
        }

        #warnings {       
            color: #1f2328 !important;
            border-color: #fff8c5;
            background-color: #fff8c5;
        }

        #errors {       
            color: #1f2328 !important;
            border-color: #ffebe9;
            background-color: #ffebe9;
        }
    </style>
    <script type="module">
        import theme from '/static/shiki/themes/github-light.js'
        import lang from '/static/shiki/langs/bsl.js'  
        import { createHighlighterCore } from '/static/shiki/core.js';   
        import { createOnigurumaEngine } from '/static/shiki/engine/oniguruma.js'

        let outputText = 'Соединение = Новый HTTPСоединение("example.com", 80);\n'
        + 'HTTPЗапрос = Новый HTTPЗапрос("/");\n'
        + 'HTTPОтвет = Соединение.ВызватьHTTPМетод("GET", HTTPЗапрос);';

        function convert(command){
            let req = new XMLHttpRequest();
            req.onload = convertOnload;
            req.responseType = "json";
            req.open("GET", "/convert?cmd=" + encodeURIComponent(command));
            req.send();
        }

        function convertOnload() {
            let output = document.getElementById("output");
            let errors = [];
            outputText = "";

            if(this.status === 200){
                outputText = this.response.result;
                errors = this.response.errors;
            } else {
                errors.push({
                    text: 'Не удалось выполнить запрос',
                    critical: true
                });
            }
            
            setOutput(outputText);
            displayErros(errors);
        }

        function setOutput(code){
            document.getElementById("output").innerHTML = highlighter.codeToHtml(code, {
                lang: 'bsl',
                theme: 'github-light'
            })
        }

        function copyToClipboard(text){
            navigator.clipboard.writeText(text);
        }

        function displayErros(errors) {
            let elementWarnings = document.getElementById("warnings");
            let elementErrors = document.getElementById("errors");
            
            let textWarnings = "";
            let textErrors = "";

            errors.forEach((record) => {
                if(record.critical){
                    textErrors += record.text + '<br/>';
                } else {
                    textWarnings += record.text + '<br/>';
                }
            });

            elementWarnings.innerHTML = textWarnings;
            elementWarnings.style.display = textWarnings.length > 0 ? 'block' : 'none';
            
            elementErrors.innerHTML = textErrors;
            elementErrors.style.display = textErrors.length > 0 ? 'block' : 'none';
        }

        document.getElementById("convert").addEventListener("click", function (e) {
            let formData = new FormData(document.forms.curl);       
            let command = formData.get("command");
            convert(command);
        });

        document.getElementById("copy").addEventListener("click", function (e) {
            copyToClipboard(outputText);
        });

        const highlighter = await createHighlighterCore({
            themes: [theme],
            langs: [lang],
            engine: createOnigurumaEngine(import('/static/shiki/wasm.js'))
        });

        setOutput(outputText);
    </script>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="images/curlone-logo.png" alt="curlone" height="200px" />
        </div>
    </div>
    <div class="container">
        <div>
            <form name="curl">
                <label for="command">Команда curl</label>
                <textarea name="command" id="command" cols="120" rows="9" spellcheck="false" placeholder="curl example.com" required autofocus></textarea>
                <input type="button" id="convert" value="Конвертировать">
            </form>
            <div id="errors" style="display: none;"></div>
        </div>
    </div>
    <div class="container">
        <div>
            <div>Код 1C</div>
            <div id="output" class="output selectable"></div>
            <input type="button" id="copy" value="Скопировать">
            <div id="warnings" style="display: none;"></div>
        </div>
    </div>
    <div class="container">
        <p>
            <a href="https://github.com/alei1180/curlone" target="_blank">curlone</a> powered by
            <a href="https://github.com/EvilBeaver/OneScript" target="_blank">OneScript</a> and
            <a href="https://github.com/autumn-library/winow" target="_blank">Winow</a>
        </p>
    </div>
</body>
</html>